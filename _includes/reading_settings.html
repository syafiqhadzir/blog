{%- comment -%}
Reading Settings Panel - AMP-Compliant with localStorage Persistence
Expert-level implementation following Google AMP best practices:
- amp-bind for reactive state management
- localStorage persistence across sessions
- WCAG 2.2 AA compliant with reduced motion support
{%- endcomment -%}

{%- comment -%}
Initialize from localStorage if available, otherwise use defaults
AMP pattern: Try localStorage first, fallback to hardcoded defaults
{%- endcomment -%}
<amp-state id="readingSettings">
  <script type="application/json">
    {
      "panelOpen": false,
      "textScale": "1",
      "lineHeight": "1-7",
      "layoutWidth": "800px"
    }
  </script>
</amp-state>

{%- comment -%}
Load saved preferences from localStorage on page load
This updates the readingSettings state after initial render
{%- endcomment -%}
<amp-script layout="container" script="reading-prefs-loader" nodom>
  <script type="text/plain" target="amp-script" id="reading-prefs-loader">
    // Load reading preferences from localStorage
    try {
      const saved = localStorage.getItem('readingPrefs');
      if (saved) {
        const prefs = JSON.parse(saved);
        // Update AMP state with saved preferences
        const state = {
          panelOpen: false, // Always start closed
          textScale: prefs.textScale || '1',
          lineHeight: prefs.lineHeight || '1-7',
          layoutWidth: prefs.layoutWidth || '800px'
        };
        AMP.setState({ readingSettings: state });
      }
    } catch (e) {
      // Silently fail if localStorage unavailable (private browsing, etc.)
      console.debug('Reading settings: localStorage unavailable');
    }
  </script>
</amp-script>

<div class="reading-settings-wrapper" style="position: relative;">
    <button type="button"
            class="reading-settings-trigger"
            id="reading-settings-btn"
            [aria-expanded]="readingSettings.panelOpen ? 'true' : 'false'"
            aria-expanded="false"
            aria-controls="reading-settings-panel"
            aria-label="Reading Settings"
            on="tap:AMP.setState({ readingSettings: { panelOpen: !readingSettings.panelOpen } })">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
    </button>

    <div id="reading-settings-panel"
         class="reading-settings-panel"
         [aria-hidden]="readingSettings.panelOpen ? 'false' : 'true'"
         aria-hidden="true"
         [hidden]="!readingSettings.panelOpen"
         hidden>
        <!-- Text Size -->
        <div class="settings-group">
            <span class="settings-label">Text Size</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '1' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '1' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 100%">100%</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '1-5' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '1-5' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 150%">150%</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '2' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '2' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 200%">200%</button>
            </div>
        </div>

        <!-- Line Height -->
        <div class="settings-group">
            <span class="settings-label">Line Height</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '1-5' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '1-5' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Compact">Compact</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '1-7' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '1-7' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '2' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '2' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Relaxed">Relaxed</button>
            </div>
        </div>

        <!-- Width -->
        <div class="settings-group">
            <span class="settings-label">Content Width</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == '600px' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: '600px' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Narrow">Narrow</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == '800px' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: '800px' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == 'full' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: 'full' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Full">Full</button>
            </div>
        </div>

        <!-- Language Selection -->
        {%- assign i18n = site.data.i18n[site.lang] -%}
        <div class="settings-group">
            <span class="settings-label">{{ i18n.language.select }}</span>
            <div class="settings-options">
                {%- comment -%} English (Active) {%- endcomment -%}
                <span class="settings-btn lang-active"
                      role="button"
                      aria-pressed="true"
                      aria-label="English (Current)">
                    English
                </span>

                {%- comment -%} Malay (Coming Soon) {%- endcomment -%}
                <span class="settings-btn lang-disabled"
                      role="button"
                      aria-pressed="false"
                      aria-disabled="true"
                      aria-label="Malay (Coming soon)"
                      title="Content translation coming soon">
                    Malay
                    <span class="lang-badge">Soon</span>
                </span>
            </div>
        </div>
    </div>
</div>

{%- comment -%}
Save reading preferences to localStorage whenever settings change
This amp-script is triggered by button taps via reading-prefs-saver.execute
{%- endcomment -%}
<amp-script layout="container" script="reading-prefs-saver" nodom id="reading-prefs-saver">
  <script type="text/plain" target="amp-script" id="reading-prefs-saver">
    // Save current reading preferences to localStorage
    try {
      const prefs = {
        textScale: AMP.getState('readingSettings').textScale || '1',
        lineHeight: AMP.getState('readingSettings').lineHeight || '1-7',
        layoutWidth: AMP.getState('readingSettings').layoutWidth || '800px'
      };
      localStorage.setItem('readingPrefs', JSON.stringify(prefs));
    } catch (e) {
      // Silently fail if localStorage unavailable
      console.debug('Reading settings: Could not save to localStorage');
    }
  </script>
</amp-script>
