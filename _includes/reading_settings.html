{%- comment -%}
Reading Settings Panel - AMP-Compliant with localStorage Persistence
Expert-level implementation following Google AMP best practices:
- amp-bind for reactive state management
- localStorage persistence across sessions
- WCAG 2.2 AA compliant with reduced motion support
{%- endcomment -%}

{%- comment -%}
Initialize from localStorage if available, otherwise use defaults
AMP pattern: Try localStorage first, fallback to hardcoded defaults
{%- endcomment -%}
<amp-state id="readingSettings">
  <script type="application/json">
    {
      "panelOpen": false,
      "textScale": "1",
      "lineHeight": "1-7",
      "layoutWidth": "800px",
      "fontFamily": "system",
      "letterSpacing": "normal",
      "wordSpacing": "normal",
      "contrastTheme": "default",
      "autoAdjust": false
    }
  </script>
</amp-state>

{%- comment -%}
Load saved preferences from localStorage on page load
This updates the readingSettings state after initial render
{%- endcomment -%}
<amp-script script="reading-prefs-loader">
  <script type="text/plain" target="amp-script" id="reading-prefs-loader">
    // Load reading preferences from localStorage
    try {
      const saved = localStorage.getItem('readingPrefs');
      if (saved) {
        const prefs = JSON.parse(saved);
        // Update AMP state with saved preferences
        const state = {
          panelOpen: false, // Always start closed
          textScale: prefs.textScale || '1',
          lineHeight: prefs.lineHeight || '1-7',
          layoutWidth: prefs.layoutWidth || '800px',
          fontFamily: prefs.fontFamily || 'system',
          letterSpacing: prefs.letterSpacing || 'normal',
          wordSpacing: prefs.wordSpacing || 'normal',
          contrastTheme: prefs.contrastTheme || 'default',
          autoAdjust: prefs.autoAdjust || false
        };
        AMP.setState({ readingSettings: state });
      }
    } catch (e) {
      // Silently fail if localStorage unavailable (private browsing, etc.)
      console.debug('Reading settings: localStorage unavailable');
    }
  </script>
</amp-script>

<div class="reading-settings-wrapper" style="position: relative;">
    <button type="button"
            class="reading-settings-trigger"
            id="reading-settings-btn"
            [aria-expanded]="readingSettings.panelOpen ? 'true' : 'false'"
            aria-expanded="false"
            aria-controls="reading-settings-panel"
            aria-label="Reading Settings"
            on="tap:AMP.setState({ readingSettings: { panelOpen: !readingSettings.panelOpen } })">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
    </button>

    <div id="reading-settings-panel"
         class="reading-settings-panel"
         [aria-hidden]="readingSettings.panelOpen ? 'false' : 'true'"
         aria-hidden="true"
         [hidden]="!readingSettings.panelOpen"
         hidden>
        <!-- Text Size -->
        <div class="settings-group">
            <span class="settings-label">Text Size</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '1' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '1' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 100%">100%</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '1-5' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '1-5' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 150%">150%</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.textScale == '2' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { textScale: '2' } }),
                            reading-prefs-saver.execute"
                        aria-label="Text size 200%">200%</button>
            </div>
        </div>

        <!-- Font Family -->
        <div class="settings-group">
            <span class="settings-label">Font Family</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.fontFamily == 'system' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { fontFamily: 'system' } }),
                            reading-prefs-saver.execute"
                        aria-label="Font family System">System</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.fontFamily == 'serif' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { fontFamily: 'serif' } }),
                            reading-prefs-saver.execute"
                        aria-label="Font family Serif">Serif</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.fontFamily == 'dyslexic' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { fontFamily: 'dyslexic' } }),
                            reading-prefs-saver.execute"
                        aria-label="Font family Dyslexic-Friendly">Dyslexic</button>
            </div>
        </div>

        <!-- Line Height -->
        <div class="settings-group">
            <span class="settings-label">Line Height</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '1-5' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '1-5' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Compact">Compact</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '1-7' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '1-7' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.lineHeight == '2' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { lineHeight: '2' } }),
                            reading-prefs-saver.execute"
                        aria-label="Line height Relaxed">Relaxed</button>
            </div>
        </div>

        <!-- Width -->
        <div class="settings-group">
            <span class="settings-label">Content Width</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == '600px' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: '600px' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Narrow">Narrow</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == '800px' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: '800px' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.layoutWidth == 'full' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { layoutWidth: 'full' } }),
                            reading-prefs-saver.execute"
                        aria-label="Content width Full">Full</button>
            </div>
        </div>

        <!-- Letter Spacing -->
        <div class="settings-group">
            <span class="settings-label">Letter Spacing</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.letterSpacing == 'normal' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { letterSpacing: 'normal' } }),
                            reading-prefs-saver.execute"
                        aria-label="Letter spacing Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.letterSpacing == 'relaxed' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { letterSpacing: 'relaxed' } }),
                            reading-prefs-saver.execute"
                        aria-label="Letter spacing Relaxed">Relaxed</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.letterSpacing == 'wide' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { letterSpacing: 'wide' } }),
                            reading-prefs-saver.execute"
                        aria-label="Letter spacing Wide">Wide</button>
            </div>
        </div>

        <!-- Word Spacing -->
        <div class="settings-group">
            <span class="settings-label">Word Spacing</span>
            <div class="settings-options">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.wordSpacing == 'normal' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { wordSpacing: 'normal' } }),
                            reading-prefs-saver.execute"
                        aria-label="Word spacing Normal">Normal</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.wordSpacing == 'relaxed' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { wordSpacing: 'relaxed' } }),
                            reading-prefs-saver.execute"
                        aria-label="Word spacing Relaxed">Relaxed</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.wordSpacing == 'wide' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { wordSpacing: 'wide' } }),
                            reading-prefs-saver.execute"
                        aria-label="Word spacing Wide">Wide</button>
            </div>
        </div>

        <!-- Contrast Theme -->
        <div class="settings-group">
            <span class="settings-label">Contrast Theme</span>
            <div class="settings-options settings-grid">
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.contrastTheme == 'default' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { contrastTheme: 'default' } }),
                            reading-prefs-saver.execute"
                        aria-label="Contrast theme Default">Default</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.contrastTheme == 'high' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { contrastTheme: 'high' } }),
                            reading-prefs-saver.execute"
                        aria-label="Contrast theme High (black on white)">High</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.contrastTheme == 'yellow-black' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { contrastTheme: 'yellow-black' } }),
                            reading-prefs-saver.execute"
                        aria-label="Contrast theme Yellow on Black">Y/B</button>
                <button type="button" class="settings-btn"
                        [aria-pressed]="readingSettings.contrastTheme == 'black-yellow' ? 'true' : 'false'"
                        on="tap:AMP.setState({ readingSettings: { contrastTheme: 'black-yellow' } }),
                            reading-prefs-saver.execute"
                        aria-label="Contrast theme Black on Yellow">B/Y</button>
            </div>
        </div>

        <!-- Preset Profiles -->
        <div class="settings-group">
            <span class="settings-label">Quick Profiles</span>
            <div class="settings-options settings-grid">
                <button type="button" class="settings-btn settings-profile"
                        on="tap:AMP.setState({
                            readingSettings: {
                                textScale: '1-5', lineHeight: '1-7', layoutWidth: '800px',
                                fontFamily: 'system', letterSpacing: 'normal', wordSpacing: 'normal',
                                contrastTheme: 'default'
                            }
                        }),reading-prefs-saver.execute"
                        aria-label="Apply Comfortable reading profile">
                    <span class="profile-icon">üòä</span> Comfort
                </button>
                <button type="button" class="settings-btn settings-profile"
                        on="tap:AMP.setState({
                            readingSettings: {
                                textScale: '2', lineHeight: '2', layoutWidth: '600px',
                                fontFamily: 'serif', letterSpacing: 'normal', wordSpacing: 'normal',
                                contrastTheme: 'high'
                            }
                        }),reading-prefs-saver.execute"
                        aria-label="Apply Large Print reading profile">
                    <span class="profile-icon">üîç</span> Large
                </button>
                <button type="button" class="settings-btn settings-profile"
                        on="tap:AMP.setState({
                            readingSettings: {
                                textScale: '1-5', lineHeight: '2', layoutWidth: 'full',
                                fontFamily: 'dyslexic', letterSpacing: 'wide', wordSpacing: 'wide',
                                contrastTheme: 'default'
                            }
                        }),reading-prefs-saver.execute"
                        aria-label="Apply Dyslexic-Friendly reading profile">
                    <span class="profile-icon">üìñ</span> Dyslexic
                </button>
                <button type="button" class="settings-btn settings-profile"
                        on="tap:AMP.setState({
                            readingSettings: {
                                textScale: '1', lineHeight: '1-5', layoutWidth: '600px',
                                fontFamily: 'system', letterSpacing: 'normal', wordSpacing: 'normal',
                                contrastTheme: 'default'
                            }
                        }),reading-prefs-saver.execute"
                        aria-label="Apply Speed Reader profile">
                    <span class="profile-icon">‚ö°</span> Speed
                </button>
            </div>
        </div>

        <!-- Visual Preview -->
        <div class="settings-preview-container">
            <span class="settings-label">Preview</span>
            <div class="settings-preview"
                 [class]="'settings-preview' +
                          ' font-' + (readingSettings.fontFamily || 'system') +
                          ' text-scale-' + (readingSettings.textScale || '1') +
                          ' letter-spacing-' + (readingSettings.letterSpacing || 'normal') +
                          ' word-spacing-' + (readingSettings.wordSpacing || 'normal') +
                          ' contrast-' + (readingSettings.contrastTheme || 'default')">
                The quick brown fox jumps over the lazy dog.
                <span style="font-weight: 700;">Bold text example.</span>
            </div>
        </div>

        <!-- Language Selection -->
        {%- assign i18n = site.data.i18n[site.lang] -%}
        <div class="settings-group">
            <span class="settings-label">{{ i18n.language.select }}</span>
            <div class="settings-options">
                {%- comment -%} English (Active) {%- endcomment -%}
                <span class="settings-btn lang-active"
                      role="button"
                      aria-pressed="true"
                      aria-label="English (Current)">
                    English
                </span>

                {%- comment -%} Malay (Coming Soon) {%- endcomment -%}
                <span class="settings-btn lang-disabled"
                      role="button"
                      aria-pressed="false"
                      aria-disabled="true"
                      aria-label="Malay (Coming soon)"
                      title="Content translation coming soon">
                    Malay
                    <span class="lang-badge">Soon</span>
                </span>
            </div>
        </div>

        <!-- Reset All Settings -->
        <div class="settings-footer">
            <button type="button"
                    class="settings-reset"
                    on="tap:AMP.setState({
                        readingSettings: {
                            textScale: '1',
                            lineHeight: '1-7',
                            layoutWidth: '800px',
                            fontFamily: 'system',
                            letterSpacing: 'normal',
                            wordSpacing: 'normal',
                            contrastTheme: 'default'
                        }
                    }),reading-prefs-saver.execute"
                    aria-label="Reset all reading settings to defaults">
                ‚Ü∫ Reset All Settings
            </button>
        </div>
    </div>
</div>

{%- comment -%}
Save reading preferences to localStorage whenever settings change
This amp-script is triggered by button taps via reading-prefs-saver.execute
{%- endcomment -%}
<amp-script layout="container" script="reading-prefs-saver" nodom id="reading-prefs-saver">
  <script type="text/plain" target="amp-script" id="reading-prefs-saver">
    // Save current reading preferences to localStorage
    try {
      const prefs = {
        textScale: AMP.getState('readingSettings').textScale || '1',
        lineHeight: AMP.getState('readingSettings').lineHeight || '1-7',
        layoutWidth: AMP.getState('readingSettings').layoutWidth || '800px',
        fontFamily: AMP.getState('readingSettings').fontFamily || 'system',
        letterSpacing: AMP.getState('readingSettings').letterSpacing || 'normal',
        wordSpacing: AMP.getState('readingSettings').wordSpacing || 'normal',
        contrastTheme: AMP.getState('readingSettings').contrastTheme || 'default',
        autoAdjust: AMP.getState('readingSettings').autoAdjust || false
      };
      localStorage.setItem('readingPrefs', JSON.stringify(prefs));
    } catch (e) {
      // Silently fail if localStorage unavailable
      console.debug('Reading settings: Could not save to localStorage');
    }
  </script>
</amp-script>
