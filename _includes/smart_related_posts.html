{%- assign RELATED_POSTS_LIMIT = 2 -%}
{%- assign current_tags = page.tags -%}
{%- assign related_posts = "" | split: "" -%}

{%- for post in site.posts -%}
  {%- if post.url != page.url -%}
    {%- assign score = 0 -%}
    {%- for tag in post.tags -%}
      {%- if current_tags contains tag -%}
        {%- assign score = score | plus: 1 -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if score > 0 -%}
      {%- capture score_padded -%}{{ score | prepend: '00' | slice: -2, 2 }}{%- endcapture -%}
      {%- capture scored_post -%}{{ score_padded }}{{ post.date | date: "%Y%m%d" }}::{{ post.url }}::{{ post.title | replace: '::', ': ' }}{%- endcapture -%}
      {%- assign related_posts = related_posts | push: scored_post -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- assign sorted_related = related_posts | sort | reverse -%}

{%- if sorted_related.size > 0 -%}
<nav class="related-posts" aria-label="Recommended posts">
    <h3 class="related-heading">Recommended for You</h3>
    <div class="related-nav">
        {%- assign count = 0 -%}
        {%- for entry in sorted_related -%}
          {%- if count < RELATED_POSTS_LIMIT -%}
            {%- assign parts = entry | split: "::" -%}
            {%- assign score = parts[0] | slice: 0, 2 | plus: 0 -%}
            {%- assign date_val = parts[0] | slice: 2, 8 -%}
            {%- assign url = parts[1] -%}
            {%- assign title = parts[2] -%}

            <a class="related-link" href="{{ url | relative_url }}"
               data-score="{{ score }}"
               {% if score >= 2 %}data-cluster="true"{% endif %}>
                <span class="nav-label">{{ date_val | date: "%d %b %Y" }}</span>
                <span class="nav-title">{{ title | truncate: 60 }}</span>
            </a>
            {%- assign count = count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
    </div>
</nav>
{%- endif -%}
