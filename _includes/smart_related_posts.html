{%- assign RELATED_POSTS_LIMIT = 3 -%}
{%- assign current_tags = page.tags -%}
{%- assign related_posts = "" | split: "" -%}

<!-- 1. Score posts by tag intersection (with date as tie-breaker) -->
{%- for post in site.posts -%}
  {%- if post.url != page.url -%}
    {%- assign score = 0 -%}
    {%- for tag in post.tags -%}
      {%- if current_tags contains tag -%}
        {%- assign score = score | plus: 1 -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if score > 0 -%}
      <!-- Sort key: Score (Padded) + Date + URL -->
      {%- capture score_padded -%}{{ score | prepend: '00' | slice: -2, 2 }}{%- endcapture -%}
      {%- capture scored_post -%}{{ score_padded }}{{ post.date | date: "%Y%m%d" }}#{{ post.url }}{%- endcapture -%}
      {%- assign related_posts = related_posts | push: scored_post -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

<!-- 2. Sort descending -->
{%- assign sorted_related = related_posts | sort | reverse -%}

{%- if sorted_related.size > 0 -%}
  <aside class="related-posts">
    <h3>Recommended for You</h3>
    <ul class="related-list">
      {%- assign count = 0 -%}
      {%- for entry in sorted_related -%}
        {%- if count < RELATED_POSTS_LIMIT -%}
          {%- assign parts = entry | split: "#" -%}
          {%- assign url = parts[1] -%}
          {%- for p in site.posts -%}
            {%- if p.url == url -%}
              <li>
                <a href="{{ p.url | relative_url }}">
                  <span class="related-title">{{ p.title }}</span>
                  <div class="related-meta">
                    {%- for t in p.tags -%}
                      {%- if current_tags contains t -%}
                        <span class="tag-match">{{ t }}</span>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                </a>
              </li>
              {%- assign count = count | plus: 1 -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
    </ul>
  </aside>
{%- endif -%}
