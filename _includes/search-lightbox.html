<amp-lightbox id="search-lightbox" layout="nodisplay" on="lightboxOpen:AMP.setState({ searchModalOpen: true }); lightboxClose:AMP.setState({ searchModalOpen: false, searchQuery: '' })">
  <div class="search-modal">
    <div class="search-modal-inner">
      <div class="search-header">
        <div class="search-container">
           <input type="text"
                 class="search-input"
                 placeholder="Search posts..."
                 on="input-debounced:AMP.setState({ searchQuery: event.value })"
                 autoFocus
                 aria-label="Search posts">
          <div class="search-icon-overlay">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>
        </div>
        <button on="tap:search-lightbox.close" class="close-search" aria-label="Close search">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="search-results-wrapper">
        <div [hidden]="!searchQuery" hidden class="search-results-info">
          Results for <span class="search-query-display" [text]="searchQuery"></span>
        </div>

        <!-- Lazy-load: only fetch search.json when modal is open -->
        <amp-list layout="fixed-height"
                  height="70vh"
                  [src]="searchModalOpen ? '{{ '/search.json' | relative_url }}' : ''"
                  src=""
                  id="search-results"
                  single-item
                  items="items"
                  binding="refresh"
                  reset-on-refresh>
          <template type="amp-mustache">
            <div class="search-hit-list">
              {{#items}}
              <div class="search-hit" [hidden]="searchQuery && titleLower.indexOf(searchQuery.toLowerCase()) == -1 && tagsLower.indexOf(searchQuery.toLowerCase()) == -1">
                <a href="{{url}}" class="search-hit-link">
                  <span class="search-hit-date">{{date}}</span>
                  <span class="search-hit-title">{{title}}</span>
                  {{#tags.length}}
                  <span class="search-hit-tags">
                    {{#tags}}<span class="search-hit-tag">{{.}}</span>{{/tags}}
                  </span>
                  {{/tags.length}}
                </a>
              </div>
              {{/items}}
            </div>
          </template>
          <div placeholder class="search-placeholder">Loading results...</div>
          <div fallback class="search-fallback">Failed to load search index.</div>
        </amp-list>

        <div class="search-no-results" [hidden]="!searchQuery || !searchModalOpen" hidden>
          <p>No results found for "<span [text]="searchQuery"></span>"</p>
        </div>
      </div>
    </div>
  </div>
</amp-lightbox>

