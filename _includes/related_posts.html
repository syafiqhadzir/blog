{%- assign max_related = include.limit | default: 3 -%}
{%- assign current_categories = page.categories -%}
{%- assign related_posts = site.posts | where_exp: "post", "post.url != page.url" -%}

{%- assign matching_posts = "" | split: "" -%}
{%- for post in related_posts -%}
{%- for category in post.categories -%}
{%- if current_categories contains category -%}
{%- assign matching_posts = matching_posts | push: post -%}
{%- break -%}
{%- endif -%}
{%- endfor -%}
{%- endfor -%}

{%- assign matching_posts = matching_posts | uniq | slice: 0, max_related -%}

{%- if matching_posts.size > 0 -%}
<aside aria-label="Related posts">
    <h2>Related Posts</h2>
    <ul class="related-posts-list" role="list" aria-label="Related articles">
        {%- for post in matching_posts -%}
        <li role="listitem">
            <a href="{{ post.url | relative_url }}" aria-label="Read {{ post.title }}">{{ post.title }}</a>
        </li>
        {%- endfor -%}
    </ul>
</aside>
{%- endif -%}