name: Deploy with Rollback

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  deployments: write
  issues: write

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          cache: 'npm'
          node-version: '24'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          ruby-version: '3.4'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: bundle exec jekyll build

      - name: Run Lighthouse CI (Pre-deploy)
        id: lighthouse-pre
        run: npm run lighthouse:ci
        continue-on-error: true

      - name: Deploy to production
        id: deploy
        run: |
          echo "Deploying to production..."
          # Add your deployment command here
          echo "deployment_id=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Wait for deployment
        run: sleep 30

      - name: Run Lighthouse CI (Post-deploy)
        id: lighthouse-post
        run: npm run lighthouse:ci
        continue-on-error: true

      - name: Check performance degradation
        id: check-degradation
        run: |
          # Compare scores and check for >5% degradation
          echo "Checking for performance degradation..."
          # Add comparison logic here
          echo "degradation=false" >> $GITHUB_OUTPUT

      - name: Rollback deployment
        if: steps.check-degradation.outputs.degradation == 'true'
        run: |
          echo "‚ö†Ô∏è Performance degradation detected! Rolling back..."
          # Add rollback command here
          exit 1

      - name: Notify team
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Deployment Rolled Back - Performance Degradation',
              body: 'Automatic rollback triggered due to performance degradation.',
              labels: ['deployment', 'performance', 'rollback']
            });
