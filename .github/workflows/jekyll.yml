# GitHub Actions CI/CD Pipeline for Jekyll AMP Blog
# Expert-level best practices with caching, E2E tests, and security

name: CI/CD Pipeline

on:
    push:
        branches: [main]
        paths-ignore:
            - '**.md'
            - 'LICENSE'
            - '.gitignore'
            - 'humans.txt'
    pull_request:
        branches: [main]
    workflow_dispatch:
    schedule:
        # Weekly security check on Sundays at 00:00 UTC
        - cron: '0 0 * * 0'

permissions:
    contents: read
    pages: write
    id-token: write
    security-events: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
    RUBY_VERSION: '3.4.1'
    NODE_VERSION: '24'
    JEKYLL_ENV: production

jobs:
    # Node.js Linting & Validation (Parallel)
    lint-node:
        name: Lint (Node)
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: TypeScript check
              run: npm run typecheck

            - name: ESLint check
              run: npm run lint:ts

            - name: Prettier check
              run: npm run format:check

            - name: Markdown lint
              run: npm run lint:md

    # Ruby Linting & Validation (Parallel)
    lint-ruby:
        name: Lint (Ruby)
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: RuboCop check
              run: bundle exec rubocop --parallel

            - name: Validate YAML
              run: |
                  echo "Validating _config.yml..."
                  ruby -ryaml -e "YAML.safe_load(File.read('_config.yml'))"
                  echo "Validating _data/menu.yml..."
                  ruby -ryaml -e "YAML.safe_load(File.read('_data/menu.yml'))"
                  echo "âœ… YAML validation passed"

            - name: Validate JSON
              run: |
                  echo "Validating site.webmanifest..."
                  ruby -rjson -e "JSON.parse(File.read('site.webmanifest'))"
                  echo "âœ… JSON validation passed"

    # Unit Tests with RSpec
    test:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint-ruby
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Run RSpec
              run: bundle exec rspec spec/unit --format documentation --format json --out test-results.json

            - name: Upload test results
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: rspec-results
                  path: test-results.json
                  retention-days: 7

    # Build and Validate
    build:
        name: Build & Validate
        runs-on: ubuntu-latest
        needs: [test, lint-node]
        timeout-minutes: 15
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Setup Pages
              id: pages
              uses: actions/configure-pages@v5

            - name: Cache Jekyll build
              uses: actions/cache@v5
              with:
                  path: |
                      .jekyll-cache
                      _site
                  key: jekyll-${{ hashFiles('**/*.md', '**/*.html', '_config.yml') }}
                  restore-keys: |
                      jekyll-

            - name: Optimize Images
              run: npm run optimize:img || echo "Image optimization skipped (no changes or tools missing)"

            - name: Build Jekyll
              run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"

            - name: Run HTMLProofer
              run: |
                  bundle exec htmlproofer ./_site \
                    --disable-external \
                    --allow-missing-href \
                    --ignore-urls "/^#/,/^mailto:/,/^javascript:/" \
                    --checks Links,Images,Scripts

            - name: Validate AMP
              run: |
                  echo "Checking AMP attribute..."
                  grep -q "âš¡\|amp" ./_site/index.html && echo "âœ… Homepage is AMP valid"

            - name: Build size report
              run: |
                  echo "## ðŸ“Š Build Size" >> $GITHUB_STEP_SUMMARY
                  TOTAL_SIZE=$(du -sh _site | cut -f1)
                  echo "**Total:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
                  SIZE_BYTES=$(du -sb _site | cut -f1)
                  if [ "$SIZE_BYTES" -gt 5242880 ]; then
                    echo "âš ï¸ Exceeds 5MB budget" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Generate SBOM (Ruby)
              run: |
                  gem install cyclonedx-ruby
                  cyclonedx-ruby -p . -o sbom-ruby.json

            - name: Setup Node.js for SBOM
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install Node.js dependencies for SBOM
              run: npm ci

            - name: Generate SBOM (Node.js)
              run: npx --yes @cyclonedx/cyclonedx-npm --output-file sbom-node.json

            - name: Upload SBOMs
              uses: actions/upload-artifact@v6
              with:
                  name: sbom
                  path: |
                      sbom-ruby.json
                      sbom-node.json
                  retention-days: 90

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v4

    # E2E Tests with Playwright
    e2e:
        name: E2E Tests
        runs-on: ubuntu-latest
        needs: build
        if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
        timeout-minutes: 20
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium webkit

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Run Playwright tests
              run: npx playwright test --project=chromium --project=webkit
              env:
                  BASE_URL: http://localhost:4000/

            - name: Upload test report
              uses: actions/upload-artifact@v6
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 7

    # Security Audit
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        needs: lint-ruby
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Run bundle audit
              run: |
                  gem install bundler-audit
                  bundle audit check --update

    # Deploy to GitHub Pages
    deploy:
        name: Deploy
        runs-on: ubuntu-latest
        needs: [build, e2e]
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        timeout-minutes: 10
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Deployment summary
              run: |
                  echo "ðŸš€ Deployed to: ${{ steps.deployment.outputs.page_url }}"
                  echo "ðŸ“… Time: $(date -u)"
