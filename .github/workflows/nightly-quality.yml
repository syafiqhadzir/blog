# Nightly Quality Workflow
# Runs comprehensive quality checks on schedule
# Includes full Lighthouse audit, security checks, and link validation

name: Nightly Quality

on:
    schedule:
        # Run every night at 2:00 AM UTC (10:00 AM MYT)
        - cron: '0 2 * * *'
    workflow_dispatch:

permissions:
    contents: read
    security-events: write

env:
    RUBY_VERSION: '3.4.1'
    NODE_VERSION: '22'

jobs:
    # Full Lighthouse audit on all pages
    lighthouse:
        name: Full Lighthouse Audit
        runs-on: ubuntu-latest
        timeout-minutes: 20
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Build Jekyll site
              run: bundle exec jekyll build
              env:
                  JEKYLL_ENV: production

            - name: Install Lighthouse CI
              run: npm install -g @lhci/cli

            - name: Run Full Lighthouse Audit
              run: |
                  lhci collect --staticDistDir=./_site --url=http://localhost/index.html
                  lhci collect --additive --url=http://localhost/about.html
                  lhci collect --additive --url=http://localhost/archive.html
                  lhci collect --additive --url=http://localhost/offline.html
                  lhci assert --preset=lighthouse:recommended || true
                  lhci upload --target=temporary-public-storage

            - name: Upload Lighthouse Report
              uses: actions/upload-artifact@v4
              with:
                  name: lighthouse-nightly-report
                  path: .lighthouseci/
                  retention-days: 30

    # Security audit for dependencies
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Ruby dependency audit
              run: |
                  gem install bundler-audit
                  bundle audit check --update

            - name: Node dependency audit
              run: npm audit --audit-level=moderate || true

    # Link and resource validation
    links:
        name: Link Validation
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Build Jekyll site
              run: bundle exec jekyll build
              env:
                  JEKYLL_ENV: production

            - name: Run HTMLProofer
              run: |
                  bundle exec htmlproofer ./_site \
                    --allow-missing-href \
                    --ignore-urls "/^#/,/^mailto:/,/^javascript:/" \
                    --checks Links,Images,Scripts \
                    --disable-external=false \
                    --enforce-https=false \
                    --ignore-status-codes "999,403,429" \
                    --typhoeus='{"ssl_verifypeer": false}' \
                    || true

    # Build size tracking
    size:
        name: Build Size Report
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: ${{ env.RUBY_VERSION }}
                  bundler-cache: true

            - name: Build Jekyll site
              run: bundle exec jekyll build
              env:
                  JEKYLL_ENV: production

            - name: Calculate build size
              run: |
                  echo "## ðŸ“Š Build Size Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  TOTAL_SIZE=$(du -sh _site | cut -f1)
                  echo "**Total size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "### File breakdown:" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  du -sh _site/* | sort -rh >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

                  # Check if size exceeds 5MB threshold
                  SIZE_BYTES=$(du -sb _site | cut -f1)
                  THRESHOLD=5242880
                  if [ "$SIZE_BYTES" -gt "$THRESHOLD" ]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "âš ï¸ **Warning:** Build size exceeds 5MB threshold!" >> $GITHUB_STEP_SUMMARY
                  fi
