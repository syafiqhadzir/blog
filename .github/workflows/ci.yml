name: CI

on:
    push:
        branches: ['main']
    pull_request:
        branches: ['main']

jobs:
    lint:
        name: Lint & Style
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: '3.4'
                  bundler-cache: true

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Install Node Dependencies
              run: npm ci

            - name: Lint Ruby
              run: bundle exec rubocop

            - name: Lint TS/ESLint
              run: npm run lint:ts

            - name: Lint Markdown
              run: npm run lint:md

            - name: Lint CSS
              run: npx stylelint "**/*.{css,scss}"

    build:
        name: Build & Test
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - uses: actions/checkout@v6

            - name: Setup Ruby
              uses: ruby/setup-ruby@v1
              with:
                  ruby-version: '3.4'
                  bundler-cache: true

            - name: Build Site
              run: bundle exec jekyll build
              env:
                  JEKYLL_ENV: production

            - name: Check HTML (Proofer)
              run: bundle exec htmlproofer ./_site --disable-external --check-html --allow-hash-href
              continue-on-error: true # Optional: Fail if you want strictly valid HTML


            # Note: E2E Tests would go here, usually passing the built site to them.
            # For now, we skip heavy E2E in this basic simulation unless explicitly requested.
